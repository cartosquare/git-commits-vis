<!DOCTYPE html>
<html>
  <head>
    <title>Terrain Context</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="http://dist.geohey.com/g-js/latest/lib/g.css">
    <script type="text/javascript" src="http://dist.geohey.com/g-js/latest/lib/g.min.js"></script>
    <script src="/static/jquery.min.js"></script>
  </head>
<body style="margin: 0; padding:0; width: 100%; height: 100%; position: absolute;">
        <div id="map" style="absolute: 1; width: 1024px; height: 512px"></div>
        <br>
        <div id="c1"></div>
        <br>
        <div id="c2"></div>
        <br>
        <div id="c3"></div>
        <br>
        <div id="c4"></div>
        <br>
        <div id="c5"></div>
        <script>
          G.ready(function() {
            var res = 0.597164283477783;
            var tilesize = 256;
            var tile_extent = tilesize * res;
            var world_originalx = -20037508.342787
            var world_originaly = 20037508.342787

            function tileIndex(x, y) {
                xx = Math.floor((x - world_originalx) / tile_extent)
                yy = Math.floor((world_originaly - y) / tile_extent)
                return [xx, yy]
            }

            function showTileExtent(e, layer) {
                layer.clear();

                [x, y] = tileIndex(e.mapX, e.mapY)
                // console.log(x)
                // console.log(y)
                x0 = world_originalx + tile_extent * x;
                y0 = world_originaly - tile_extent * y;
                var g = new G.Graphic.Polygon([[[x0, y0], [x0 + tile_extent, y0], [x0 + tile_extent, y0 - tile_extent], [x0, y0 - tile_extent]]], {}, {
                    fillColor: '#ff0',
                    outlineColor: '#0f0',
                    outlineOpacity: 0.5,
                    fillOpacity: 0.1
                });
                g.addTo(layer);
            }

            var map = new G.Map('map',{
                initStatus: {
                    center: [12963716, 4898001],
                    res: res,
                }
            });
            var layer1 = new G.Layer.Tile('http://a.tile.openstreetmap.org/{z}/{x}/{y}.png');
            layer1.addTo(map);

            var layer2 = new G.Layer.Tile('http://192.168.31.241:3030/simple/google/{z}/{x}/{y}/.png', {
            });

            layer2.addTo(map);

            graphicLayer = new G.Layer.Graphic();
            graphicLayer.addTo(map);

            map.addListener('click', function(e) {
                [x, y] = tileIndex(e.mapX, e.mapY)
                key = x + '_' + y;
                $.ajax({
                    url: '/classify?image=' + key,
                    type: 'GET',
                    error: function(xhr, textStatus, errorThrown) {
                        console.error("Error: " + textStatus + " / " + JSON.stringify(errorThrown));
                    },
                    success: function(data, textStatus) {
                        // console.info("Success: " + textStatus + " / " + JSON.stringify(data));
                        data_obj = JSON.parse(data)
                        count = 1
                        for (key in data_obj) {
                            id = 'c' + count;
                            document.getElementById(id).innerHTML = key + ' : ' + data_obj[key].toFixed(4);
                            count += 1;
                        }
                    }
                });
            });

            map.addListener('mousemove', function(e) {
                showTileExtent(e, graphicLayer)
            });

            map.zoomRes([12963716, 4898001], res);
        });
        </script>
</body>
</html>
